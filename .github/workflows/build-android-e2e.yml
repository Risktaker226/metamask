name: Build Android E2E APKs

on:
  workflow_call:
    inputs:
      build_type:
        description: "The type of build to perform"
        required: false
        default: "main"
        type: string
      metamask_environment:
        description: "The environment to build for"
        required: false
        default: "qa"
        type: string

jobs:
  build-android-apks:
    name: Build Android APK Only
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Java 17 (required for Android SDK)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Install Android SDK tools
        run: |
          echo "‚öôÔ∏è Installing Android SDK tools..."
          mkdir -p /usr/local/lib/android/sdk/cmdline-tools
          cd /usr/local/lib/android/sdk/cmdline-tools
          wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
          unzip -q cmdline-tools.zip
          mv cmdline-tools latest || true
          rm cmdline-tools.zip
          export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
          export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools
          yes | sdkmanager --licenses || true
          sdkmanager --update || true
          sdkmanager "platform-tools" "build-tools;34.0.0" "platforms;android-34"
          echo "‚úÖ Android SDK installed successfully"

      - name: Generate local keystore automatically
        run: |
          echo "üîë Generating temporary Android keystore..."
          mkdir -p android/app
          rm -f android/app/debug.keystore || true
          keytool -genkeypair \
            -v \
            -keystore android/app/debug.keystore \
            -storepass android \
            -keypass android \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -alias androiddebugkey \
            -dname "CN=Android Debug,O=Android,C=US"
          echo "‚úÖ Keystore generated successfully"

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Install project dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          yarn install --frozen-lockfile

      - name: Build Android APK
        run: |
          echo "üèóÔ∏è Building Android APK..."
          cd android
          ./gradlew assembleRelease
          echo "‚úÖ APK build completed."

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: android/app/build/outputs/apk/release/*.apk
