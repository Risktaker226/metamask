name: Build Android E2E APKs

on:
  workflow_call:
    inputs:
      build_type:
        description: "The type of build to perform"
        required: false
        default: "main"
        type: string
      metamask_environment:
        description: "The environment to build for"
        required: false
        default: "qa"
        type: string

jobs:
  build-android-apks:
    name: Build Android APK Only
    runs-on: ubuntu-22.04

    steps:
      - name: ğŸ§­ Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Install Java 17 (required for Android SDK)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: âš™ï¸ Install Android SDK Commandline Tools
        run: |
          echo "âš™ï¸ Installing Android SDK tools..."
          export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd "$ANDROID_SDK_ROOT/cmdline-tools"
          
          # TÃ©lÃ©chargement du package officiel
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O sdk-tools.zip
          unzip -q sdk-tools.zip -d tools
          mv tools "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          rm sdk-tools.zip

          export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools
          
          yes | sdkmanager --licenses || true
          sdkmanager --update || true
          sdkmanager "platform-tools" "build-tools;34.0.0" "platforms;android-34"
          echo "âœ… Android SDK installed successfully"

      - name: ğŸ”‘ Generate local keystore automatically
        run: |
          echo "ğŸ”‘ Generating temporary Android keystore..."
          mkdir -p android/app
          rm -f android/app/debug.keystore || true
          keytool -genkeypair \
            -v \
            -keystore android/app/debug.keystore \
            -storepass android \
            -keypass android \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -alias androiddebugkey \
            -dname "CN=Android Debug,O=Android,C=US"
          echo "âœ… Keystore generated successfully"

      - name: ğŸ“¦ Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: ğŸ“¦ Install project dependencies
        run: |
          echo "ğŸ“¦ Installing JS dependencies..."
          yarn install --frozen-lockfile

      - name: ğŸ§© Patch deprecated compile() calls
        run: |
          echo "ğŸ§© Patching deprecated Gradle compile() calls..."
          find node_modules/react-native-aes-crypto-forked/android -name "build.gradle" -type f -exec sed -i 's/compile /implementation /g' {} +
          echo "âœ… Gradle dependencies patched."

      - name: ğŸ—ï¸ Build Android release APK
        run: |
          echo "ğŸ—ï¸ Building Android APK..."
          cd android
          ./gradlew assembleRelease --no-daemon
          echo "âœ… APK build completed."

      - name: ğŸ“¤ Upload built APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: android/app/build/outputs/apk/release/*.apk
